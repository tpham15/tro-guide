<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tr·ªç Guide - ƒê·∫∑t l·ªãch xem ph√≤ng</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="page-shell">
    <header class="hero-card">
      <div class="hero-header">
        <div class="hero-row">
          <span class="logo-chip">TG</span>
          <h1>Tr·ªç Guide</h1>
        </div>
        <span class="hero-badge">Kh√¥ng m√¥i gi·ªõi ¬∑ Kh√¥ng th·ªïi gi√°</span>
        <p class="hero-subtitle">
          T√¨m ph√≤ng tr·ªç th·∫≠t ‚Äì kh√¥ng m√¥i gi·ªõi, kh√¥ng n√¢ng gi√°. Guide ƒë·ªãa ph∆∞∆°ng d·∫´n b·∫°n xem 2‚Äì3 ph√≤ng ph√π h·ª£p ch·ªâ trong m·ªôt l·ªãch h·∫πn.
        </p>
      </div>
    </header>

    <main class="form-shell">
      <section class="form-card">
        <div class="form-head">
          <div class="form-copy">
            <p class="form-kicker">Y√™u c·∫ßu d·∫´n xem</p>
            <h2>Chia s·∫ª nhu c·∫ßu c·ªßa b·∫°n</h2>
            <p>ƒêi·ªÅn th√¥ng tin ƒë·ªÉ Tr·ªç Guide s·∫Øp x·∫øp guide v√† g·ªçi x√°c nh·∫≠n trong v√†i ph√∫t.</p>
          </div>
          <div class="meta">
            <span class="meta-item">
              <span class="meta-icon" aria-hidden="true">üìû</span>
              <strong>24/7</strong>
              <small>H·ªó tr·ª£</small>
            </span>
            <span class="meta-item">
              <span class="meta-icon" aria-hidden="true">‚ú®</span>
              <strong>150+</strong>
              <small>Guide tuy·ªÉn ch·ªçn</small>
            </span>
          </div>
        </div>

        <form id="booking-form" class="booking-form">
          <div class="form-grid">
            <label class="field">
              <span>H·ªç t√™n*</span>
              <input type="text" name="customer_name" required placeholder="Nguy·ªÖn VƒÉn A" />
            </label>
            <label class="field">
              <span>S·ªë ƒëi·ªán tho·∫°i*</span>
              <input type="tel" name="customer_phone" required placeholder="090 xxx xxxx" />
            </label>
            <label class="field">
              <span>Zalo</span>
              <input type="text" name="customer_zalo" placeholder="@zalo ho·∫∑c s·ªë" />
            </label>
            <div class="field span-2 area-field-group">
              <span>Khu v·ª±c b·∫°n mu·ªën ·ªü*</span>
              <div class="area-fields">
                <label class="sub-field">
                  <span>Khu v·ª±c ch√≠nh</span>
                  <select name="area_main" required>
                    <option value="" selected disabled>Ch·ªçn khu v·ª±c</option>
                    <option value="TP.Th·ªß ƒê·ª©c">TP.Th·ªß ƒê·ª©c</option>
                    <option value="Qu·∫≠n 1">Qu·∫≠n 1</option>
                    <option value="Qu·∫≠n 3">Qu·∫≠n 3</option>
                    <option value="Qu·∫≠n 4">Qu·∫≠n 4</option>
                    <option value="Qu·∫≠n 5">Qu·∫≠n 5</option>
                    <option value="Qu·∫≠n 6">Qu·∫≠n 6</option>
                    <option value="Qu·∫≠n 7">Qu·∫≠n 7</option>
                    <option value="Qu·∫≠n 8">Qu·∫≠n 8</option>
                    <option value="Qu·∫≠n 10">Qu·∫≠n 10</option>
                    <option value="Qu·∫≠n 11">Qu·∫≠n 11</option>
                    <option value="Qu·∫≠n 12">Qu·∫≠n 12</option>
                    <option value="Qu·∫≠n B√¨nh Th·∫°nh">Qu·∫≠n B√¨nh Th·∫°nh</option>
                    <option value="Qu·∫≠n B√¨nh T√¢n">Qu·∫≠n B√¨nh T√¢n</option>
                    <option value="Qu·∫≠n G√≤ V·∫•p">Qu·∫≠n G√≤ V·∫•p</option>
                    <option value="Qu·∫≠n T√¢n B√¨nh">Qu·∫≠n T√¢n B√¨nh</option>
                    <option value="Qu·∫≠n T√¢n Ph√∫">Qu·∫≠n T√¢n Ph√∫</option>
                    <option value="Qu·∫≠n Ph√∫ Nhu·∫≠n">Qu·∫≠n Ph√∫ Nhu·∫≠n</option>
                    <option value="Huy·ªán B√¨nh Ch√°nh">Huy·ªán B√¨nh Ch√°nh</option>
                    <option value="Huy·ªán C·∫ßn Gi·ªù">Huy·ªán C·∫ßn Gi·ªù</option>
                    <option value="Huy·ªán C·ªß Chi">Huy·ªán C·ªß Chi</option>
                    <option value="Huy·ªán H√≥c M√¥n">Huy·ªán H√≥c M√¥n</option>
                    <option value="Huy·ªán Nh√† B√®">Huy·ªán Nh√† B√®</option>
                    <option value="(Kh√°c)">(Kh√°c)</option>
                  </select>
                </label>
                <label class="sub-field">
                  <span>M√¥ t·∫£ chi ti·∫øt</span>
                  <input type="text" name="area_detail" placeholder="VD: G·∫ßn ƒêH Kinh T·∫ø, ƒë∆∞·ªùng X√¥ Vi·∫øt Ngh·ªá Tƒ©nh..." />
                  <small class="field-hint">Cho ch√∫ng t√¥i bi·∫øt s√°t nh·∫•t b·∫°n mu·ªën ·ªü ƒë√¢u.</small>
                </label>
              </div>
            </div>
            <label class="field">
              <span>Ng√¢n s√°ch t·ªëi thi·ªÉu (tri·ªáu VND)</span>
              <input type="number" name="budget_min" min="0.1" step="0.1" placeholder="3.5" inputmode="decimal" />
              <small class="field-hint">VD: 3.5 nghƒ©a l√† 3.500.000ƒë</small>
            </label>
            <label class="field">
              <span>Ng√¢n s√°ch t·ªëi ƒëa (tri·ªáu VND)</span>
              <input type="number" name="budget_max" min="0.1" step="0.1" placeholder="8.0" inputmode="decimal" />
              <small class="field-hint">VD: 8.0 nghƒ©a l√† 8.000.000ƒë</small>
            </label>
            <div class="field span-2 room-type-group">
              <span>Lo·∫°i ph√≤ng mu·ªën xem* <small class="field-hint">Ch·ªçn t·ªëi ƒëa 2 lo·∫°i ph√π h·ª£p nh·∫•t</small></span>
              <div class="room-type-options">
                <label class="room-option"><input type="checkbox" name="room_type" value="tro" /><span>Ph√≤ng tr·ªç</span></label>
                <label class="room-option"><input type="checkbox" name="room_type" value="cth" /><span>Chung c∆∞ th∆∞·ªùng</span></label>
                <label class="room-option"><input type="checkbox" name="room_type" value="ccmini" /><span>Chung c∆∞ mini</span></label>
                <label class="room-option"><input type="checkbox" name="room_type" value="canho" /><span>CƒÉn h·ªô d·ªãch v·ª•</span></label>
                <label class="room-option"><input type="checkbox" name="room_type" value="ghep" /><span>Ph√≤ng gh√©p</span></label>
                <label class="room-option"><input type="checkbox" name="room_type" value="nhangan" /><span>Nh√† nguy√™n cƒÉn</span></label>
              </div>
            </div>
            <label class="field">
              <span>S·ªë ph√≤ng mu·ªën xem</span>
              <select name="rooms_to_view">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
              </select>
            </label>
            <label class="field span-2">
              <span>Th·ªùi gian r·∫£nh*</span>
              <input type="text" name="time_slot" required placeholder="Chi·ªÅu nay 15-18h, cu·ªëi tu·∫ßn..." />
            </label>
            <label class="field span-2">
              <span>Ghi ch√∫ th√™m</span>
              <textarea name="note" placeholder="V√≠ d·ª•: c·∫ßn ch·ªó g·ª≠i xe, ∆∞u ti√™n ph√≤ng m·ªõi..."></textarea>
            </label>
          </div>
          <div class="cta-block">
            <div class="guide-fee-info">
              <span aria-hidden="true">‚ÑπÔ∏è</span>
              <p>Ph√≠ c√¥ng guide t·ª´ 20.000ƒë ‚Äì 50.000ƒë/chuy·∫øn. Ch·ªâ thanh to√°n sau khi b·∫°n xem ph√≤ng.</p>
            </div>
            <button type="submit" class="primary-btn">G·ª≠i y√™u c·∫ßu</button>
            <p class="cta-note">Kh√¥ng thu ti·ªÅn ch·ªß tr·ªç ‚Äì ph√≠ d·∫´n xem ƒë∆∞·ª£c b√°o tr∆∞·ªõc khi x√°c nh·∫≠n.</p>
          </div>
        </form>

        <div id="message" class="alert" style="display:none"></div>
      </section>
    </main>
  </div>

  <script>
    const form = document.getElementById('booking-form');
    const messageBox = document.getElementById('message');

    const showMessage = (type, text) => {
      messageBox.textContent = text;
      messageBox.className = `alert ${type}`;
      messageBox.style.display = 'block';
    };

    const roomTypeInputs = Array.from(document.querySelectorAll('input[name="room_type"]'));

    const enforceRoomTypeLimit = () => {
      const checked = roomTypeInputs.filter((input) => input.checked);
      if (checked.length >= 2) {
        roomTypeInputs.forEach((input) => {
          if (!input.checked) {
            input.disabled = true;
          }
        });
      } else {
        roomTypeInputs.forEach((input) => {
          input.disabled = false;
        });
      }
    };

    roomTypeInputs.forEach((input) => {
      input.addEventListener('change', enforceRoomTypeLimit);
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      messageBox.style.display = 'none';

      const formData = new FormData(form);
      const payload = Object.fromEntries(formData.entries());

      payload.budget_min = payload.budget_min ? Number(payload.budget_min) : null;
      payload.budget_max = payload.budget_max ? Number(payload.budget_max) : null;
      payload.rooms_to_view = payload.rooms_to_view ? Number(payload.rooms_to_view) : 1;

      const selectedRoomTypes = Array.from(
        form.querySelectorAll('input[name="room_type"]:checked')
      ).map((input) => input.value);
      if (!selectedRoomTypes.length) {
        showMessage('error', 'Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 lo·∫°i ph√≤ng.');
        return;
      }
      payload.room_type = selectedRoomTypes.join(',');

      const areaMain = payload.area_main ? payload.area_main.trim() : '';
      const areaDetail = payload.area_detail ? payload.area_detail.trim() : '';
      const existingArea = payload.area ? payload.area.trim() : '';

      let computedArea = existingArea;
      if (!computedArea) {
        if (areaMain && areaDetail) {
          computedArea = `${areaMain} - ${areaDetail}`;
        } else if (areaMain) {
          computedArea = areaMain;
        } else if (areaDetail) {
          computedArea = areaDetail;
        }
      }

      payload.area_main = areaMain || null;
      payload.area_detail = areaDetail || null;
      payload.area = computedArea;

      try {
        const res = await fetch('/api/bookings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const body = await res.json();
          throw new Error(body.error || 'Kh√¥ng g·ª≠i ƒë∆∞·ª£c y√™u c·∫ßu');
        }
        form.reset();
        roomTypeInputs.forEach((input) => {
          input.disabled = false;
        });
        showMessage('success', 'ƒê√£ g·ª≠i y√™u c·∫ßu. Tr·ªç Guide s·∫Ω li√™n h·ªá b·∫°n s·ªõm nh·∫•t!');
      } catch (err) {
        showMessage('error', err.message);
      }
    });
  </script>
</body>
</html>
